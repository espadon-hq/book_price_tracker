# book_price_tracker/docker-compose.yml
version: '3.9'

services:
  db:
    image: postgres:15-alpine
    container_name: postgres_db
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis_broker
    # Redis –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —è–∫ –±—Ä–æ–∫–µ—Ä –¥–ª—è Celery —Ç–∞ —è–∫ –∫–µ—à –¥–ª—è Django.
    ports:
      - "6379:6379"

  web:
    build: .
    container_name: django_web
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
    ports:
      - "8000:8000"
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      REDIS_HOST: redis # –í–∫–∞–∑—É—î–º–æ —Ö–æ—Å—Ç –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Redis
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started # Web —Ç–∞–∫–æ–∂ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ Redis –¥–ª—è –∫–µ—à—É–≤–∞–Ω–Ω—è

  # üÜï –ù–û–í–ò–ô –°–ï–†–í–Ü–°: Celery Worker
  # üÜï –û–ù–û–í–õ–ï–ù–ò–ô –°–ï–†–í–Ü–°: Celery Worker
  celery_worker:
    build: .
    container_name: celery_worker
    # ‚ùå –ü–û–ú–ò–õ–ö–û–í–ê –ö–û–ú–ê–ù–î–ê: command: celery -A book_price_tracker worker -l info
    # ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ê –ö–û–ú–ê–ù–î–ê: 
    command: python -m celery -A config worker -l info 
    volumes:
      - .:/app
    environment:
      POSTGRES_HOST: db
      REDIS_HOST: redis
    depends_on:
      - web
      - redis
      - db

  # üÜï –û–ù–û–í–õ–ï–ù–ò–ô –°–ï–†–í–Ü–°: Celery Beat (–ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫)
  celery_beat:
    build: .
    container_name: celery_beat
    # ‚ùå –ü–û–ú–ò–õ–ö–û–í–ê –ö–û–ú–ê–ù–î–ê: command: celery -A book_price_tracker beat -l info --scheduler ...
    # ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–ê –ö–û–ú–ê–ù–î–ê:
    command: python -m celery -A config beat -l info --scheduler django_celery_beat.schedulers.DatabaseScheduler
    volumes:
      - .:/app
    environment:
      POSTGRES_HOST: db
      REDIS_HOST: redis
    depends_on:
      - celery_worker
      - redis
      - db

  nginx:
    image: nginx:stable-alpine
    container_name: nginx_proxy
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web

volumes:
  postgres_data: